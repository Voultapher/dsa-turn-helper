<!DOCTYPE html>
<html>

<head>
    <title>DSA Turn Helper</title>

    <style>
        body {
            /* width: 100%; */
            /* height: 100%; */
            /* margin: 0; */

            font-size: 2rem;
            font-family: "Times New Roman", Times, serif;
            background-color: #ffffff;
        }

        button {
            font-size: 0.5em;
            text-decoration: none;

            border: solid 1px black;
            border-radius: 0px;

            padding: 0.3rem 0.7rem;

            color: black;
            background-color: white;
            cursor: pointer;

            transition-duration: 0.2s;

            /* top | horizontal | bottom */
            margin: auto 2px auto;
        }

        hr {
            border-top: 1px solid black;
            border-bottom: none;
        }

        button:hover {
            /* color: #9555af; */
            /* border-color: #9555af; */
            background-color: #eeeeee;
        }

        input {
            font-size: 0.5em;
            border: 1px solid #4F4F4F;
            /* margin: 0 1px; */
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 32px;
            height: 32px;
            box-sizing: border-box;
            padding: 0;
            /* border: 1px solid black; */
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
        }

        #toolbar {
            display: flex;
            justify-content: space-between;
        }

        #flex-container {
            display: flex;
            flex-direction: row;
        }

        #overview {
            padding: 0.3125em;
            flex: 50%;
        }

        #turn-view {
            padding: 0.3125em;
            flex: 50%;
        }

        .individual-name-input {
            width: 8em;
        }

        .inidividual-num-input {
            width: 4.75em;
        }

        .individual-sim-input {
            width: 3em;
        }

        .individual-sim-name {
            width: 10em;
        }

        /* Responsive layout - makes a one column-layout instead of two-column layout */
        @media (max-width: 88rem) {
            body {
                /* Scale up the base size to make it easier on mobile. */
                font-size: 4rem;
            }

            #flex-container {
                flex-direction: column;
            }

            #overview {
                padding: 0;
            }

            #turn-view {
                padding: 0;
            }

            #region-sep {
                /* width: 100%; */
                visibility: hidden;
                margin: 0;
                padding: 0;
            }

            .individual-name-input {
                width: 4.5em;
            }

            .inidividual-num-input {
                width: 3em;
            }

            .individual-sim-input {
                width: 2em;
            }

            .individual-sim-name {
                width: 5em;
            }

            .individual-skip-label {
                width: 0em;
                visibility: hidden;
            }
        }

        .individual {
            font-size: 0.7em;
            margin: 0.2232em auto;
            align-items: center;
        }

        .individual>div {
            margin: 0;
        }
    </style>

    <script>
        "use strict";

        // Util

        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Version 4.0
        const pSBC = (p, c0, c1, l) => {
            let r, g, b, P, f, t, h, i = parseInt, m = Math.round, a = typeof (c1) == "string";
            if (typeof (p) != "number" || p < -1 || p > 1 || typeof (c0) != "string" || (c0[0] != 'r' && c0[0] != '#') || (c1 && !a)) return null;
            if (!this.pSBCr) this.pSBCr = (d) => {
                let n = d.length, x = {};
                if (n > 9) {
                    [r, g, b, a] = d = d.split(","), n = d.length;
                    if (n < 3 || n > 4) return null;
                    x.r = i(r[3] == "a" ? r.slice(5) : r.slice(4)), x.g = i(g), x.b = i(b), x.a = a ? parseFloat(a) : -1
                } else {
                    if (n == 8 || n == 6 || n < 4) return null;
                    if (n < 6) d = "#" + d[1] + d[1] + d[2] + d[2] + d[3] + d[3] + (n > 4 ? d[4] + d[4] : "");
                    d = i(d.slice(1), 16);
                    if (n == 9 || n == 5) x.r = d >> 24 & 255, x.g = d >> 16 & 255, x.b = d >> 8 & 255, x.a = m((d & 255) / 0.255) / 1000;
                    else x.r = d >> 16, x.g = d >> 8 & 255, x.b = d & 255, x.a = -1
                } return x
            };
            h = c0.length > 9, h = a ? c1.length > 9 ? true : c1 == "c" ? !h : false : h, f = this.pSBCr(c0), P = p < 0, t = c1 && c1 != "c" ? this.pSBCr(c1) : P ? { r: 0, g: 0, b: 0, a: -1 } : { r: 255, g: 255, b: 255, a: -1 }, p = P ? p * -1 : p, P = 1 - p;
            if (!f || !t) return null;
            if (l) r = m(P * f.r + p * t.r), g = m(P * f.g + p * t.g), b = m(P * f.b + p * t.b);
            else r = m((P * f.r ** 2 + p * t.r ** 2) ** 0.5), g = m((P * f.g ** 2 + p * t.g ** 2) ** 0.5), b = m((P * f.b ** 2 + p * t.b ** 2) ** 0.5);
            a = f.a, t = t.a, f = a >= 0 || t >= 0, a = f ? a < 0 ? t : t < 0 ? a : a * P + t * p : 0;
            if (h) return "rgb" + (f ? "a(" : "(") + r + "," + g + "," + b + (f ? "," + m(a * 1000) / 1000 : "") + ")";
            else return "#" + (4294967296 + r * 16777216 + g * 65536 + b * 256 + (f ? m(a * 255) : 0)).toString(16).slice(1, f ? undefined : -2)
        }

        function roll_d6() {
            return Math.floor(Math.random() * (1 - 1 + 6)) + 1;
        }

        // --- Parties ---

        window.addEventListener('DOMContentLoaded', (event) => {
            document.getElementById('file-input')
                .addEventListener('change', load_parties, false);

            render_parties();

            // Debug
            init_sim();
        });

        function add_party() {
            let name = document.getElementById("party-name").value;

            if (name === "") {
                name = "Die Namenlosen"
            }

            let color = document.getElementById("party-color").value;
            let individuals = [];

            parties.push({ name, color, individuals });
            render_parties();
        }

        function download_parties() {
            let current_date = new Date().toJSON();
            let filename = `dsa-turn-helper-${current_date}.json`;
            let text = JSON.stringify(parties);

            let element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        function trigger_load_parties() {
            document.getElementById('file-input').click();
        }

        function load_parties(event) {
            let file = event.target.files[0];
            if (!file) {
                return;
            }
            let reader = new FileReader();
            reader.onload = (eve) => {
                let contents = eve.target.result;
                let parsed_parties = JSON.parse(contents);
                parties = parsed_parties;
                render_parties();

            };
            reader.readAsText(file);
        }

        // Fill with usable demo.
        let parties = [
            {
                name: "Players", color: "#5591ff", individuals: [
                    { name: "Gubo Der Weise", health: 33, initiative: 12 },
                    { name: "Bratna die Schnelle", health: 10, initiative: 1 },
                    { name: "Anoyah die Schlaue", health: 27, initiative: 17 },
                ]
            },
            {
                name: "Enemies", color: "#ff417e", individuals: [
                    { name: "Midlife-crisis Troll", health: 54, initiative: 7 },
                    { name: "Echte Schlange", health: 6, initiative: 25 },
                ]
            },
        ];

        // Full recreate on every change, not the most efficient.
        // But this is fairly small anyway and plays nicely with history view.
        //
        // Kind of a poor mans React.
        function render_parties() {
            // console.debug("render_parties was called", JSON.stringify(parties));

            let new_parties_node = document.createElement("div");
            new_parties_node.id = "parties";

            parties.map((party, party_id) => {
                new_parties_node.appendChild(
                    make_party(party, party_id)
                );
            });

            let parties_node = document.getElementById("parties");
            parties_node.replaceWith(new_parties_node);
        }

        function make_party(party, party_id) {
            let node = document.createElement('div');
            node.className = "party";

            node.appendChild(make_party_toolbar(party, party_id));

            let light_color_a = pSBC(0.72, party.color);
            let light_color_b = pSBC(0.88, party.color);

            party.individuals.map((individual, i) => {
                let color = (i % 2) === 0 ? light_color_a : light_color_b;
                node.appendChild(make_individual(color, individual, party_id, i));
            });

            node.style.marginBottom = "0.625em";

            return node;
        }

        function add_input_restore(input, restore_name, party, party_id) {
            let restore_val = party[restore_name];
            if (restore_val !== undefined) {
                input.value = restore_val;
            }
            input.addEventListener('change', (event) => {
                parties[party_id][restore_name] = event.target.value;
            });
        }

        function make_party_toolbar(party, party_id) {
            let node = document.createElement('div');
            node.className = "party-toolbar";
            node.style.backgroundColor = party.color;
            node.style.display = "flex";

            node.appendChild(document.createTextNode(party.name));

            let flex_box = document.createElement('div');
            flex_box.style.display = "flex";
            flex_box.style.justifyContent = "flex-end";
            flex_box.style.marginLeft = "auto";

            let name_input = document.createElement('input');
            name_input.type = "text";
            name_input.className = "individual-name-input";
            name_input.placeholder = "Name";
            add_input_restore(name_input, "name_input", party, party_id);
            flex_box.appendChild(name_input);

            let health_input = document.createElement('input');
            health_input.className = "inidividual-num-input";
            health_input.type = "number";
            health_input.placeholder = "Health";
            add_input_restore(health_input, "health_input", party, party_id);
            flex_box.appendChild(health_input);

            let initiative_input = document.createElement('input');
            initiative_input.className = "inidividual-num-input";
            initiative_input.type = "number";
            initiative_input.placeholder = "INI Base";
            add_input_restore(initiative_input, "initiative_input", party, party_id);
            flex_box.appendChild(initiative_input);

            let add_btn = document.createElement('button');
            add_btn.textContent = "Add";
            add_btn.style.margin = "0 0 0 0.3em";
            add_btn.addEventListener('click', (event) => {
                let name = name_input.value;

                if (name === "") {
                    switch (Math.floor(Math.random() * 3)) {
                        case 0:
                            name = 'Die Namenlose';
                            break;
                        case 1:
                            name = 'Das Namenlose';
                            break;
                        case 2:
                            name = 'Der Namenlose';
                            break;
                    }
                }

                let health = Number(health_input.value);
                let initiative = Number(initiative_input.value);

                parties[party_id].individuals.push({ name, health, initiative });
                render_parties();
            });
            flex_box.appendChild(add_btn);

            let delete_btn = document.createElement('button');
            delete_btn.textContent = "Delete Party";
            delete_btn.style.margin = "0 0 0 2.3em";
            delete_btn.addEventListener('click', (event) => {
                parties.splice(party_id, 1);
                render_parties();
            });
            flex_box.appendChild(delete_btn);

            node.appendChild(flex_box);

            return node;
        }

        // individual {name: str, health: num, initiative: num}
        function make_individual(color, individual, party_id, id) {
            let node = document.createElement('div');
            node.className = "individual";
            node.style.display = "flex";
            node.style.flexDirection = "row";
            node.style.backgroundColor = color;

            let name_node = document.createElement('div');
            name_node.style.width = "10em";
            name_node.style.textOverflow = "ellipsis";
            name_node.style.overflow = "hidden";
            name_node.style.whiteSpace = "nowrap";
            name_node.style.marginRight = "0.5em";
            name_node.appendChild(document.createTextNode(individual.name));
            node.appendChild(name_node);

            let health_node = document.createElement('div');
            health_node.style.marginRight = "0.65em";
            health_node.style.width = "3.5em";
            health_node.appendChild(document.createTextNode(`H: ${individual.health}`));
            node.appendChild(health_node);

            let initiative_node = document.createElement('div');
            // initiative_node.style.marginRight = "1em";
            initiative_node.style.width = "3.5em";
            initiative_node.appendChild(document.createTextNode(`I: ${individual.initiative}`));
            node.appendChild(initiative_node);

            let flex_box = document.createElement('div');
            flex_box.style.display = "flex";
            flex_box.style.flexDirection = "row";
            flex_box.style.justifyContent = "flex-end";
            flex_box.style.alignItems = "center";
            flex_box.style.margin = "0 0 0 auto";

            let delete_btn = document.createElement('button');
            delete_btn.textContent = "Delete";
            delete_btn.style.marginRight = "0";
            delete_btn.style.fontSize = "0.625em";
            delete_btn.addEventListener('click', (event) => {
                parties[party_id].individuals.splice(id, 1);
                render_parties();
            });
            flex_box.appendChild(delete_btn);

            node.appendChild(flex_box);

            return node;
        }

        // --- Turn View Simulation ---

        let sim = {};

        function make_action_2_individual(action_1_individual) {
            return {
                uuid: action_1_individual.uuid,
                name: action_1_individual.name,
                initiative: action_1_individual.initiative - 8,
                action: 2,
                color: action_1_individual.color,
            };
        }

        function make_action_split(individuals) {
            let result = [];

            individuals.forEach(individual => {
                individual.action = 1;
                result.push(individual);

                if (individual.initiative > 0) {
                    result.push(make_action_2_individual(individual));
                }
            });

            return result;
        }

        function update_action_split(individuals) {
            individuals.forEach(individual => {
                let { action, initiative, uuid } = individual;

                if (action === 2) {
                    return;
                }

                let action_2_idx = individuals.findIndex(
                    other => other.action === 2 && other.uuid === uuid
                );

                if (action_2_idx === -1 && initiative > 0) {
                    individuals.push(make_action_2_individual(individual));
                } else if (initiative > 0) {
                    individuals[action_2_idx].initiative = initiative - 8;
                } else if (action_2_idx !== -1) {
                    individuals.splice(action_2_idx, 1);
                }
            });
        }

        function init_sim() {
            let individuals = parties.map((party) => {
                // Experimenting gave me the impression that just using the
                // base color was less confusing in the simulation.
                let light_color = pSBC(0.78, party.color);

                return make_action_split(party.individuals.map((individual, i) => {
                    // deep copy
                    let sim_individual = JSON.parse(JSON.stringify(individual));

                    sim_individual.color = light_color;
                    sim_individual.uuid = uuidv4();
                    sim_individual.ini_change = 0;
                    return sim_individual;
                }));
            }).flat();

            if (individuals.length < 1) {
                alert("Simulating no-one breaks the universe! Don't do that.");
                return;
            }

            sim = {
                cursor: {
                    round: 0,
                    turn: 0,
                },
                rounds: [
                    { turns: [individuals] }
                ],
            };

            sim.last_active_turn = sim.rounds[sim.cursor.round].turns[sim.cursor.turn];

            render_sim();
        }


        function render_sim() {
            // console.debug("render_sim was called", JSON.stringify(sim));

            let { round: round_cursor, turn: turn_cursor } = sim.cursor;

            let round = sim.rounds[round_cursor];

            let view_type = '';

            if (round === undefined) {
                // Create new history entry if not been here before.
                let last_round = sim.rounds[round_cursor - 1];
                let last_active_turn = last_round.turns[
                    active_round_length(last_round.turns[last_round.turns.length - 1]) - 1
                ];

                sim.rounds[round_cursor] = {
                    turns: [JSON.parse(JSON.stringify(last_active_turn))]
                };
            }

            round = sim.rounds[round_cursor];

            let turn = round.turns[turn_cursor];

            if (turn === undefined) {
                // TODO check that at least one individual is still active.
                // Or disable the skip box once only one remains.
                round.turns.push(JSON.parse(JSON.stringify(sim.last_active_turn)));
            }

            // Chaning initiative can have an effect on the action split.
            // So apply it every time an update is made.
            update_action_split(round.turns[turn_cursor]);


            // After the action split changed, the cursor might now dangle
            // in nothing, move back if necessary.
            // sim.cursor.turn = active_round_length(round.turns) - 1;
            // turn_cursor = sim.cursor.turn;

            // Right now a turn only contains individuals, to make it easier
            // to read alias it under that name.
            let individuals = round.turns[turn_cursor];

            let new_sim_box_node = document.createElement("div");
            new_sim_box_node.id = "turn-view";

            let sorted_individuals = individuals.sort((a, b) => {
                // Second action of faster individual comes before equally
                // fast first action.
                if (a.initiative === b.initiative) {
                    return a.action > b.action ? -1 : 1;
                }

                return b.initiative - a.initiative;
            });

            let skipped_individuals = sorted_individuals.filter(x => x.skip);
            let active_individuals = sorted_individuals.filter(x => !x.skip);

            const is_latest_round = (round_cursor + 1) === sim.rounds.length;
            const is_latest_turn = (turn_cursor + 1) === round.turns.length;

            if (is_latest_round && round.turns.length === 1) {
                if (round_cursor === 0 && turn_cursor === 0) {
                    view_type = 'Start';
                } else {
                    view_type = 'New Round';
                }
            } else if (is_latest_turn) {
                view_type = 'New Turn';
            } else {
                view_type = 'History';
            }

            const is_history = view_type === 'History';

            new_sim_box_node.appendChild(make_sim_toolbar(round_cursor, turn_cursor, view_type));
            new_sim_box_node.appendChild(document.createElement('hr'));

            active_individuals.map((individual, i) => {
                new_sim_box_node.appendChild(
                    make_sim_individual(individual.color, individual, i === turn_cursor, is_history)
                );
            });

            if (skipped_individuals.length > 0) {
                new_sim_box_node.appendChild(document.createElement('hr'));

                skipped_individuals.map((individual, i) => {
                    new_sim_box_node.appendChild(
                        make_sim_individual("#eae8e8", individual, false)
                    );
                });
            }

            let sim_box_node = document.getElementById("turn-view");
            sim_box_node.replaceWith(new_sim_box_node);
        }

        function active_round_length(turns) {
            return turns
                .reduce((sum, individual) => sum + (individual.skip === true ? 0 : 1), 0);
        }

        function make_sim_toolbar(round, turn, view_type) {
            let node = document.createElement('div');
            node.style.display = "flex";
            node.style.flexDirection = "row";
            node.style.alignItems = "center";

            let turn_div = document.createElement('div');
            turn_div.style.width = '10em';
            turn_div.appendChild(document.createTextNode(
                `Turn: ${round + 1}.${turn + 1} - ${view_type}`
            ));
            node.appendChild(turn_div);

            let previous_btn = document.createElement('button');
            previous_btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>';
            previous_btn.style.margin = "0 0 0 0.625em";
            previous_btn.style.lineHeight = "0";
            previous_btn.style.width = "3em";
            previous_btn.addEventListener('click', (event) => {
                sim.cursor.turn -= 1;

                if (sim.cursor.turn < 0) {
                    // Prevent negative time travel.
                    if (sim.cursor.round > 0) {
                        sim.cursor.round -= 1;

                        let round = sim.rounds[sim.cursor.round];
                        sim.cursor.turn = active_round_length(round.turns) - 1;
                    } else {
                        sim.cursor.turn = 0;
                    }

                }
                render_sim();
            });
            node.appendChild(previous_btn);

            let next_btn = document.createElement('button');
            next_btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24"  ><path d="M0 0h24v24H0z" fill="none"/><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>';
            next_btn.style.margin = "0 0.625em 0 0";
            next_btn.style.lineHeight = "0";
            next_btn.style.width = "3em";
            next_btn.addEventListener('click', (event) => {
                // With skipping things get funky so we have to check,
                // as roundlength is dynamic.
                let last_active_turn = sim.rounds[sim.cursor.round].turns[sim.cursor.turn];

                sim.last_active_turn = last_active_turn;

                let current_round_len = active_round_length(
                    last_active_turn
                );

                sim.cursor.turn += 1;

                if (sim.cursor.turn >= current_round_len) {
                    sim.cursor.round += 1;
                    sim.cursor.turn = 0;
                }
                render_sim();
            });
            node.appendChild(next_btn);

            let new_btn = document.createElement('button');
            new_btn.textContent = "All New";
            new_btn.style.margin = "0 0 0 auto";
            new_btn.style.height = "2.2em";
            new_btn.addEventListener('click', init_sim);
            node.appendChild(new_btn);

            return node;
        }

        function make_select_option(value) {
            let option_node = document.createElement('option');
            option_node.value = value;
            option_node.appendChild(document.createTextNode(value));
            return option_node;
        }

        function make_effect_select(individual) {
            let effect_select = document.createElement('select');
            effect_select.style.margin = '0';
            effect_select.style.fontSize = '0.8em';
            effect_select.style.width = '4.5em';

            let select_placeholder = document.createElement('option');
            select_placeholder.disabled = true;
            select_placeholder.selected = true;
            select_placeholder.hidden = true;
            select_placeholder.appendChild(document.createTextNode('effect'));
            effect_select.appendChild(select_placeholder);

            effect_select.appendChild(make_select_option('Wunde erlitten'));
            effect_select.appendChild(make_select_option('Frei ausgewichen'));
            effect_select.appendChild(make_select_option('Gezielt ausgewichen Misserfolg'));
            effect_select.appendChild(make_select_option('Passierschlag erlitten'));
            effect_select.appendChild(make_select_option('Orientieren'));
            effect_select.appendChild(make_select_option('Manuell'));

            effect_select.addEventListener('change', (event) => {
                switch (effect_select.value) {
                    case 'Wunde erlitten':
                        individual.ini_change -= 2;
                        individual.wunden += 1;
                        break;
                    case 'Frei ausgewichen':
                        individual.ini_change -= 4;
                        individual.reversible_negatie_effects += 4;
                        break;
                    case 'Gezielt ausgewichen Misserfolg':
                        individual.ini_change -= 2;
                        individual.reversible_negatie_effects += 2;
                        break;
                    case 'Passierschlag erlitten':
                        let d_val = roll_d6();
                        individual.ini_change -= d_val;
                        individual.reversible_negatie_effects += d_val;
                        break;
                    case 'Orientieren':
                        if (individual.reversible_negatie_effects !== undefined) {
                            individual.ini_change += individual.reversible_negatie_effects;
                        }
                        // TODO
                        // individual.ini_change += (6 - individual.initial_init_roll);
                        individual.reversible_negatie_effects = 0;
                        break;
                    case 'Manuell':
                        individual.manual_ini_input = true;
                        break;

                    default:
                        console.error(`Unknown effect value: ${effect_select.value}`);
                }

                render_sim();
            });

            return effect_select;
        }

        function make_skip(individual) {
            let flex_box = document.createElement('div');
            flex_box.style.display = "flex";
            flex_box.style.flexDirection = "row";
            flex_box.style.justifyContent = "flex-end";
            flex_box.style.alignItems = "center";
            flex_box.style.margin = "0 0 0 auto";

            let skip_label = document.createElement('label');
            skip_label.className = 'individual-skip-label';
            skip_label.for = "disable_checkbox";
            skip_label.textContent = "skip";
            skip_label.style.color = "#4F4F4F"
            flex_box.appendChild(skip_label);

            let disable_checkbox = document.createElement('input');
            disable_checkbox.type = "checkbox";
            disable_checkbox.name = "disable_checkbox";
            disable_checkbox.style.margin = "0 0.8em";
            disable_checkbox.style.width = "2em";
            disable_checkbox.style.height = "2em";
            disable_checkbox.checked = individual.skip;
            disable_checkbox.addEventListener('click', (event) => {
                // Let's pray ref semantics stay the same.
                let turn_cursor = sim.cursor.turn;

                // Apply skip status to all future events.
                // This makes limited sense otherwise.
                for (
                    let round_cursor = sim.cursor.round;
                    round_cursor < sim.rounds.length;
                    round_cursor++
                ) {
                    let round = sim.rounds[round_cursor];
                    for (
                        ;
                        turn_cursor < round.turns.length;
                        turn_cursor++
                    ) {
                        let future_individual = round.turns[turn_cursor]
                            .find(future_individual => individual.uuid == future_individual.uuid);

                        future_individual.skip = disable_checkbox.checked;
                    }

                    // Start at 0 for next rounds.
                    turn_cursor = 0;
                }

                render_sim();
            });
            flex_box.appendChild(disable_checkbox);

            return flex_box;
        }

        function make_custom_initative_input(individual) {
            let initiative_input = document.createElement('input');
            // initiative_input.className = "individual-sim-input";
            initiative_input.type = "number";
            initiative_input.style.fontSize = "0.8em";
            initiative_input.placeholder = 'INI add';
            initiative_input.style.margin = "0 0.1em 0 0.65em";
            initiative_input.style.width = "4.2em";
            initiative_input.addEventListener('change', (event) => {
                individual.ini_change += Number(event.target.value);
                individual.manual_ini_input = false;
                render_sim();
            });

            return initiative_input;
        }

        function make_sim_individual(color, individual, is_current, is_history) {
            let node = document.createElement('div');
            node.className = "individual";
            node.style.display = "flex";
            node.style.flexDirection = "row";
            node.style.alignItems = "center";
            node.style.backgroundColor = color;

            let pointer_box = document.createElement('div');
            pointer_box.style.width = "1em";
            pointer_box.style.height = "1em";
            pointer_box.style.padding = "0.14em";

            if (is_current === true) {
                pointer_box.innerHTML = '<svg xmlns = "http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>';

            }
            node.appendChild(pointer_box);

            let name_node = document.createElement('div');
            name_node.className = "individual-sim-name";
            name_node.style.textOverflow = "ellipsis";
            name_node.style.overflow = "hidden";
            name_node.style.whiteSpace = "nowrap";
            name_node.style.marginRight = "0.5em";
            name_node.appendChild(document.createTextNode(
                individual.skip
                    ? individual.name
                    : `${individual.action} ${individual.name}`
            ));
            node.appendChild(name_node);


            if (individual.action !== 1) {
                // Second actions are too noisy and confusing otherwise.
                return node;
            }

            node.appendChild(document.createTextNode("H:"));

            let health_input = document.createElement('input');
            health_input.className = "individual-sim-input";
            health_input.type = "number";
            health_input.value = individual.health;
            health_input.style.fontSize = "0.8em";
            health_input.style.marginRight = "0.65em";
            health_input.style.marginLeft = "0.1em";
            health_input.addEventListener('change', (event) => {
                individual.health = Number(event.target.value);
                render_sim();
            });
            if (is_history) {
                health_input.disabled = true;
            }
            node.appendChild(health_input);

            if (individual.manual_ini_input) {
                node.appendChild(document.createTextNode('I:'));
                node.appendChild(make_custom_initative_input(individual));
            } else {
                let initiative_val = document.createElement('div');
                initiative_val.style.width = '2.6em';

                initiative_val.appendChild(document.createTextNode(
                    `I: ${individual.initiative}`
                ));
                node.appendChild(initiative_val);

                const ini_change = individual.ini_change;

                let initiative_diff = document.createElement('div');
                initiative_diff.style.width = '3em';
                initiative_diff.style.display = "flex";
                initiative_diff.style.alignItems = "center";

                if (ini_change !== undefined && ini_change !== 0) {
                    let arrow_box = document.createElement('div');
                    arrow_box.style.width = '0.7em';
                    arrow_box.style.height = '1em';
                    arrow_box.style.margin = '0 0.3em 0 0';
                    arrow_box.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 2 24 24" ><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 7.77L18.39 18H5.61L12 7.77M12 4L2 20h20L12 4z"/></svg>';
                    initiative_diff.appendChild(arrow_box);
                    initiative_diff.appendChild(document.createTextNode(ini_change));
                }

                node.appendChild(initiative_diff);
            }

            if (!is_history) {
                if (!individual.manual_ini_input) {
                    node.appendChild(make_effect_select(individual));
                }
                node.appendChild(make_skip(individual));
            }

            return node;
        }
    </script>
</head>

<body>
    <div id="flex-container">
        <div id="overview">
            <div id="toolbar">
                <div style="display: flex;">
                    DSA
                    <input type="text" id="party-name" name="party-name" placeholder="New Party Name"
                        style="margin: 0 0 0 0.625em; width: 11em; height: 100%; box-sizing: border-box;">
                    <input style="margin: 0 0.1em; height: 100%; width: 2.5em;" type="color" id="party-color"
                        name="party-name" value="#f0e1ce">
                    <button style="margin: 0; height: 100%" type="button" onclick="add_party()">Add Party</button>
                </div>

                <div style="display: flex; margin-left: auto; justify-content: flex-end;">
                    <button style="margin: 0; height: 100%;" type="button"
                        onclick="trigger_load_parties()">Load</button>
                    <button style="margin: 0; height: 100%;" type="button"
                        onclick="download_parties()">Download</button>
                </div>
                <input type="file" id="file-input" style="display: none;" />
            </div>

            <hr />

            <div id="parties"></div>
        </div>

        <hr id="region-sep" />

        <div id="turn-view"></div>
    </div>
</body>

</html>